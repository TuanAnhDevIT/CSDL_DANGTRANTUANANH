CREATE DATABASE QUANLYBANHANG

USE QUANLYBANHANG

CREATE TABLE KHACHHANG
(
MAKH CHAR(4)PRIMARY KEY,
HOTEN VARCHAR(40),
DCHI VARCHAR(40),
SODT VARCHAR(20),
NGSINH SMALLDATETIME,
DOANHSO MONEY,
NGDK SMALLDATETIME,
)
CREATE TABLE NHANVIEN 
( 
MANV   CHAR(4) PRIMARY KEY,
HOTEN   VARCHAR(40),
SODT  VARCHAR(20),
NGVL    SMALLDATETIME,
) 
DROP TABLE SANPHAM
CREATE TABLE SANPHAM
(
MASP CHAR(4)PRIMARY KEY,
TENSP VARCHAR (40),
DVT VARCHAR (10),
NUOCSX VARCHAR(40),
GIA MONEY,
)
CREATE TABLE HOADON
(
SOHD INT PRIMARY KEY,
NGHD SMALLDATETIME,
MAKH CHAR(4),
MANV CHAR(4),
TRIGIA MONEY,
)
ALTER TABLE HOADON 
ADD CONSTRAINT FK_HOADON_MAKH FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH)
ALTER TABLE HOADON 
ADD CONSTRAINT FK_HOADON_MANV FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)
CREATE TABLE CTHD
(
SOHD INT,
MASP CHAR(4),
SL INT,
)
ALTER TABLE CTHD
ADD CONSTRAINT FK_CTHD_SOHD FOREIGN KEY (SOHD) REFERENCES HOADON(SOHD)
ALTER TABLE CTHD
ADD CONSTRAINT FK_CTHD_MASP FOREIGN KEY (MASP) REFERENCES SANPHAM(MASP)

/*1.In ra danh sach cac san pham (MASP,TENSP) do "trung quoc" san xuat*/
SELECT MASP, TENSP
FROM SANPHAM
WHERE NUOCSX = 'TRUNG QUOC'

/*2.In ra danh sach cac san pham (MASP,TENSP)co don vi tinh la "cay","quyen".*/
SELECT MASP, TENSP
FROM SANPHAM
WHERE DVT='CAY' OR DVT='QUYEN'

/*3.In ra danh sach cac san pham (MASP,TENSP) co MASP bat dau la "B" va ket thuc la "01".*/
SELECT MASP, TENSP
FROM SANPHAM
WHERE MASP LIKE 'B%01'

/*4.In ra danh sach cac san pham (MASP,TENSP)do "trung quoc" san xuat co gia tu 30000 den 40000.*/
SELECT MASP, TENSP
FROM SANPHAM
WHERE (NUOCSX='TRUNG QUOC') AND (GIA BETWEEN 30000 AND 40000)

/*5.In ra danh sach cac san pham (MASP,TENSP)do "trung quoc" hoac "thai lan" san xuat co gia tu 30000 den 40000.*/
SELECT MASP, TENSP
FROM SANPHAM
WHERE (NUOCSX='TRUNG QUOC' OR NUOCSX='THAILAN') AND (GIA BETWEEN 30000 AND 40000)

/* 6) IN RA SOHD, TRIGIA BAN TRONG NGAY 1/1/2007 VÀ 2/1/2007 */
SELECT SOHD, TRIGIA
FROM HOADON
WHERE NGHD='01/01/2007' OR NGHD='02/01/2007'

/* 7) IN RA SOHD, TRIGIA BAN TRONG THANG 1/2007 SX NGAY TANG DAN VA TRI GIA GIAM DAN*/
SELECT SOHD, TRIGIA
FROM HOADON
WHERE MONTH(NGHD)=1 AND YEAR(NGHD)=2007
ORDER BY NGHD ASC, TRIGIA DESC

/*8. In ra danh sách các khách hàng (MAKH, HOTEN) đã mua hàng trong ngày 1/1/2007. */
SELECT KH.MAKH, HOTEN
FROM KHACHHANG KH JOIN HOADON HD ON KH.MAKH= HD.MAKH
WHERE NGHD= '01/01/2007'

/*9. In ra số hóa đơn, trị giá các hóa đơn do nhân viên có tên “Nguyen Van B” lập trong ngày
28/10/2006. */
SELECT HD.SOHD, TRIGIA
FROM HOADON HD JOIN NHANVIEN NV ON HD.MANV= NV.MANV
WHERE NV.HOTEN= 'NGUYEN VAN B' AND NGHD= '28/10/2006'

/*10. In ra danh sách các sản phẩm (MASP,TENSP) được khách hàng có tên “Nguyen Van A” mua trong
tháng 10/2006.*/
SELECT CT.MASP,TENSP
FROM SANPHAM SP, CTHD CT, HOADON HD, KHACHHANG KH
WHERE SP.MASP = CT.MASP AND
	  CT.SOHD = HD.SOHD AND
	  HD.MAKH = KH.MAKH AND
	  HOTEN= 'NGUYEN VAN A' AND
	  MONTH(NGHD)= 10 AND YEAR(NGHD)=2006

/*11. Tìm các số hóa đơn đã mua sản phẩm có mã số “BB01” hoặc “BB02”.*/
SELECT SOHD
FROM CTHD
WHERE MASP='BB01' OR MASP='BB02'

/*12. Tìm các số hóa đơn đã mua sản phẩm có mã số “BB01” hoặc “BB02”, mỗi sản phẩm mua với số
lượng từ 10 đến 20.*/
SELECT SOHD
FROM CTHD
WHERE (MASP='BB01' OR MASP='BB02')AND (SL BETWEEN 10 AND 20)

/* 13) IN RA SOHD MUA BB01 VA BB02 MOI SAN PHAM MUA VOI SL TU 10-20*/
SELECT SOHD 
FROM CTHD 
WHERE MASP='BB01' AND 
      SOHD IN( SELECT SOHD
			   FROM CTHD 
			   WHERE (MASP='BB02') AND
	                 ( SL BETWEEN 10 AND 20))

/* 14) IN RA MASP TENSP DO TRUNG QUOC SX HOAC BAN RA TRONG 1/1/2007*/
SELECT SP.MASP,TENSP
FROM SANPHAM SP, CTHD CTHD, HOADON HD 
WHERE (SP.MASP=CTHD.MASP)AND (HD.SOHD=CTHD.SOHD)AND((NUOCSX='Trung Quoc') OR (NGHD='20070101'))
GROUP BY SP.MASP,SP.TENSP

/* 15) IN RA MASP TENSP KHONG BAN DUOC */
SELECT MASP, TENSP 
FROM SANPHAM 
WHERE MASP NOT IN (SELECT DISTINCT MASP 
	               FROM CTHD) 

/*16. In ra danh sách các sản phẩm (MASP,TENSP) không bán được trong năm 2006.*/
SELECT MASP, TENSP 
FROM SANPHAM 
WHERE MASP NOT IN 
(	SELECT MASP 
 	FROM CTHD, HOADON HD
	where CTHD.sohd=HD.SOHD
	AND YEAR(NGHD)=2006
) 
/*17. In ra danh sách các sản phẩm (MASP,TENSP) do “Trung Quoc” sản xuất không bán được trong
năm 2006.*/
SELECT MASP, TENSP 
FROM SANPHAM 
WHERE NUOCSX='TrungQuoc'
AND   MASP NOT IN 
(	SELECT MASP 
 	FROM CTHD, HOADON HD
	where CTHD.SOHD=HD.SOHD
	AND   YEAR(NGHD)= 2006
) 
/*18. In ra sohd da mua tat ca san pham do Singapore san xuat*/
SELECT SOHD
FROM HOADON
WHERE NOT EXISTS (SELECT *
				  FROM SANPHAM
				  WHERE NUOCSX='SINGAPORE' AND NOT EXISTS(SELECT *
														  FROM CTHD
														  WHERE HOADON.SOHD=CTHD.SOHD
														  AND CTHD.MASP=SANPHAM.MASP))

												
/*19. Có bao nhiêu hóa đơn không phải của khách hàng đăng ký thành viên mua?*/
SELECT COUNT(SOHD) AS SOHD_NULL
FROM HOADON
WHERE MAKH ='Null'

/*20. Có bao nhiêu sản phẩm khác nhau được bán ra trong năm 2006*/
SELECT COUNT(DISTINCT MASP) AS SOSP_nam2006
FROM CTHD CTHD JOIN HOADON HD ON CTHD.SOHD=HD.SOHD
WHERE YEAR(NGHD)=2006

/*21 Cho biet tri gia hoa don cao nhat thap nhat */
SELECT MAX(TRIGIA) AS CAONHAT,
	   MIN(TRIGIA) AS THAPNHAT
FROM HOADON

/*22 Cho biet tri gia trung binh cua cac hoa don trong nam 2006*/
SELECT AVG(TRIGIA) AS TRUNGBINH
FROM HOADON
WHERE YEAR(NGHD)=2006

/* 23. Tinh doanh thu ban hang trong nam 2006*/
SELECT SUM(TRIGIA) AS DOANHTHU
FROM HOADON
WHERE YEAR(NGHD)=2006

/* 24 Tim sohd co tri gia cao nhat nam 2006*/
SELECT SOHD
FROM HOADON
WHERE TRIGIA IN(SELECT MAX(TRIGIA) AS CAONHAT
				FROM HOADON
				WHERE YEAR(NGHD)=2006)

/* 25 Tim ho ten khach hang co tri gia hoadon cao nhat nam 2006*/
SELECT HOTEN
FROM KHACHHANG
WHERE MAKH IN(SELECT MAKH
			  FROM HOADON
			  WHERE TRIGIA IN(SELECT MAX(TRIGIA) AS CAONHAT
							  FROM HOADON
							  WHERE YEAR(NGHD)=2006))

/* 26 In ra 3 (makh,hoten) co doanh so cao nhat*/
SELECT TOP 3 MAKH, HOTEN, DOANHSO
FROM KHACHHANG
ORDER BY DOANHSO DESC

/* 27 In ra cac san pham (masp,tensp) co gia ban bang 1 trong 3 mua gia cao nhat*/
SELECT MASP,TENSP,GIA
FROM SANPHAM
WHERE GIA IN (SELECT DISTINCT TOP 3 GIA 
			  FROM SANPHAM 
			  ORDER BY GIA DESC)

/*28. In ra danh sách các sản phẩm (MASP, TENSP) do “Thai Lan” sản xuất có giá bằng 1 trong 3 mức
giá cao nhất (của tất cả các sản phẩm).*/
SELECT MASP, TENSP, GIA
FROM SANPHAM
WHERE NUOCSX='THAILAN' AND GIA IN(SELECT DISTINCT TOP 3 GIA 
								  FROM SANPHAM 
								  ORDER BY GIA DESC)

/*29. In ra danh sách các sản phẩm (MASP, TENSP) do “Trung Quoc” sản xuất có giá bằng 1 trong 3 mức
giá cao nhất (của sản phẩm do “Trung Quoc” sản xuất).*/
SELECT MASP,TENSP,GIA
FROM SANPHAM
WHERE NUOCSX='TRUNGQUOC' AND GIA IN(SELECT DISTINCT TOP 3 GIA
									FROM SANPHAM
									WHERE NUOCSX='TRUNGQUOC' 
									ORDER BY GIA DESC)
/*30. * In ra danh sách 3 khách hàng có doanh số cao nhất (sắp xếp theo kiểu xếp hạng).*/
SELECT TOP 3 MAKH, HOTEN, DOANHSO
FROM KHACHHANG
ORDER BY DOANHSO DESC

/*31. Tinh tong so sp do trung quoc san xuat*/
SELECT COUNT(MASP) AS SOSP_TQSANXUAT
FROM SANPHAM
WHERE NUOCSX='TRUNGQUOC'

/*32. Tinh Tong so San Pham cua tung nuoc*/
SELECT NUOCSX, COUNT(MASP) AS SO_SP
FROM SANPHAM
GROUP BY NUOCSX

/*33. Tim gia ban cao nhat, trung binh, thap nhat cua cac san pham voi tung nuoc*/
SELECT NUOCSX,
	   MAX(GIA) AS GIA_CAONHAT,
	   MIN(GIA) AS GIA_THAPNHAT,
	   AVG(GIA) AS GIA_TRUNGBINH
FROM SANPHAM
GROUP BY NUOCSX

/*34. Tinh doanh thu ban moi ngay*/
SELECT NGHD, SUM(TRIGIA) AS DOANHTHU
FROM HOADON
GROUP BY NGHD

/*35. Tinh tong so luong tung san pham ban ra trong thang 10/2006*/
SELECT MASP, SUM(SL) AS TONGSL
FROM CTHD CTHD JOIN HOADON HD ON CTHD.SOHD= HD.SOHD
WHERE MONTH(NGHD) =10 AND YEAR(NGHD)=2006
GROUP BY MASP

/*36. Tinh doanh thu ban moi thang trong nam 2006*/
SELECT MONTH(NGHD) AS THANG, SUM(TRIGIA) AS DOANHTHU
FROM HOADON
WHERE YEAR(NGHD)=2006
GROUP BY MONTH(NGHD)

/*37. Tìm hóa đơn có mua ít nhất 4 sản phẩm khác nhau.*/
SELECT SOHD, COUNT(MASP) AS TONG_SL
FROM CTHD 
GROUP BY SOHD
HAVING COUNT(MASP)>=4

/*38. Tìm hóa đơn có mua 3 sản phẩm do “Viet Nam” sản xuất (3 sản phẩm khác nhau).*/
SELECT CTHD.SOHD, COUNT(CTHD.MASP) AS TONG_SL
FROM CTHD, SANPHAM SP
WHERE SP.MASP=CTHD.MASP AND
	  SP.NUOCSX='VIETNAM'
GROUP BY CTHD.SOHD
HAVING COUNT(CTHD.MASP)>=3

/*39. Tìm khách hàng (MAKH, HOTEN) có số lần mua hàng nhiều nhất.*/
SELECT HOADON.MAKH, COUNT(HOADON.SOHD) AS SO_HD_MUA
FROM KHACHHANG JOIN HOADON ON KHACHHANG.MAKH=HOADON.MAKH
GROUP BY HOADON.MAKH
HAVING COUNT(HOADON.SOHD) >= ALL (SELECT COUNT(HOADON.SOHD)
								  FROM HOADON
								  GROUP BY MAKH)
/*40. Tháng mấy trong năm 2006, doanh số bán hàng cao nhất ?*/
SELECT MONTH(NGHD) AS THANG, SUM(TRIGIA) AS TONGTIEN
FROM HOADON
WHERE YEAR(NGHD)='2006'
GROUP BY MONTH(NGHD)
HAVING SUM(TRIGIA) >= ALL (SELECT SUM(TRIGIA)
						   FROM HOADON
						   WHERE YEAR(NGHD)='2006'
						   GROUP BY MONTH(NGHD))
/*41. Tìm sản phẩm (MASP, TENSP) có tổng số lượng bán ra thấp nhất trong năm 2006.*/
SELECT CTHD.MASP, SUM(SL) AS TONGSOLUONG
FROM CTHD, SANPHAM, HOADON
WHERE CTHD.MASP=SANPHAM.MASP AND
	  HOADON.SOHD=CTHD.SOHD AND
	  YEAR(NGHD)='2006'
GROUP BY CTHD.MASP
HAVING SUM(SL) <= ALL (SELECT SUM(SL) 
					   FROM CTHD, HOADON
					   WHERE CTHD.SOHD=HOADON.SOHD AND YEAR(NGHD)='2006'
					   GROUP BY CTHD.MASP)
/*42. *Mỗi nước sản xuất, tìm sản phẩm (MASP,TENSP) có giá bán cao nhất.*/
SELECT SANPHAM.MASP, NUOCSX
FROM HOADON, CTHD, SANPHAM
WHERE SANPHAM.MASP=CTHD.MASP AND HOADON.SOHD=CTHD.SOHD
GROUP BY SANPHAM.MASP, NUOCSX
HAVING GIA >= ALL(SELECT MAX(GIA), NUOCSX
			      FROM SANPHAM
				  GROUP BY SANPHAM.MASP,NUOCSX)
/*43. Tìm nước sản xuất sản xuất ít nhất 3 sản phẩm có giá bán khác nhau.*/
SELECT DISTINCT NUOCSX
FROM SANPHAM
GROUP BY NUOCSX
HAVING COUNT(DISTINCT GIA)>=3 AND COUNT(MASP)>=3

/*44. *Trong 10 khách hàng có doanh số cao nhất, tìm khách hàng có số lần mua hàng nhiều nhất.*/
SELECT TOP 1 HOADON.MAKH, HOTEN,COUNT(DOANHSO)DEM
FROM KHACHHANG, HOADON
WHERE KHACHHANG.MAKH=HOADON.MAKH
GROUP BY HOADON.MAKH, HOTEN, DOANHSO
HAVING DOANHSO IN(SELECT TOP 10 DOANHSO
				  FROM KHACHHANG
				  ORDER BY DOANHSO DESC)
ORDER BY DEM DESC
	